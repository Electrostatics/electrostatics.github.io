---
layout: external_contributions
title: Treecode-Accelerated Boundary Integral PB Solver (TABI-PB)
prev_section:
next_section:
permalink:
---

{% include no-prev-next.html %}
<script type="text/javascript" language="JavaScript"><!--
function HideContent(d) {
document.getElementById(d).style.display = "none";
}
function ShowContent(d) {
document.getElementById(d).style.display = "block";
}
function ReverseDisplay(d) {
if(document.getElementById(d).style.display == "none") { document.getElementById(d).style.display = "block"; }
else { document.getElementById(d).style.display = "none"; }
}
function Open(d) {
document.getElementById(d).style.display = "block";
}
//-->
window.onload = function() {
  // Check if hash exists
  if(window.location.hash) {
    // Remove the "#" from the hash
    hash = window.location.hash.substr(1);
    // Display element with id == hash
    document.getElementById(hash).style.display = "block";
  }
}
</script>

<!---
{% include no-prev-next.html %}
--->

The Treecode-Accelerated Boundary Integral Poisson-Boltzmann solver (TABI-PB) <a href="http://www.sciencedirect.com/science/article/pii/S0021999113002404">(Geng, 2013)</a> calculates electrostatics of solvated biomolecules governed by the linearized Poisson-Boltzmann equation. It uses a well-posed boundary integral Poisson-Boltzmann formulation to ensure rapid convergence. In addition, a fast treecode algorithm for the screened Coulomb potential <a href="http://www.sciencedirect.com/science/article/pii/S0021999109000916">(Li, 2009)</a> is applied to speed up the matrix-vector products in each GMRES iteration  <a href="https://www.researchgate.net/publication/222488429_The_electric_potential_of_a_macromolecule_in_a_solvent_A_fundamental_approach">(Juffer, 1991)</a>. The molecular surfaces, which divide the entire domain into solute region and solvent region, are generated by MSMS <a href="http://mgl.scripps.edu/people/sanner/html/papers/msmsTextAndFigs.pdf">(Sanner, 1996)</a>, or NanoShaper <a href="http://www.ncbi.nlm.nih.gov/pubmed/23577073">(Decherchi, 2013)</a>. The TABI-PB solver serves as an effective alternative to the multigrid finite difference APBS when the surface potential accuracy or system memory capacity becomes a concern.  

#### TABI-PB algorithm

The coupled integral equations derived from the linearized Poisson-Boltzmann equation are

\\[\frac{1}{2}(1+\epsilon)\phi(\textbf{x})-\int_\Gamma(K_1(\textbf{x},\textbf{y})\frac{\partial{\phi(\textbf{y})}}{\partial{v}}+K_2(\textbf{x},\textbf{y})\phi(\textbf{y}))dS_\textbf{y}=S_1(\textbf{x})\\]

\\[\frac{1}{2}(1+\frac{1}{\epsilon})\frac{\partial{\phi(\textbf{x})}}{\partial{v}}-\int_\Gamma(K_3(\textbf{x},\textbf{y})\frac{\partial{\phi(\textbf{y})}}{\partial{v}}+K_4(\textbf{x},\textbf{y})\phi(\textbf{y}))dS_\textbf{y}=S_2(\textbf{x}), \textbf{x}\in\Gamma\\]

for the surface potential $\phi$, and its normal derivative $\frac{\partial\phi}{\partial v}$ on the surface $\Gamma$. The kernels $K_{1,2,3,4}$ are linear combinations of the Coulomb and screened Coulomb potentials:
\\[G_0(\textbf{x},\textbf{y})=\frac{1}{4\pi |\textbf{x}-\textbf{y}|},
G_{\kappa}(\textbf{x},\textbf{y})=\frac{e^{-\kappa|\textbf{x}-\textbf{y}|}}{4\pi |\textbf{x}-\textbf{y}|}\\]
  and their first and second derivatives.

The sums in the discretized form of the integral equations above have the form of N-body interactions,

\\[ V_i=\sum_{j=1,j \neq i}^{N} q_jG(\textbf{x}_i,\textbf{x}_j), i=1,...,N \\]

where $G$ is the screened Coulomb potential kernel, $\textbf{x}_i, \textbf{x}_j$ are the centroids of the triangles, and $q_j$ is the charge at $\textbf{x}_j$. The particles (centroids of the triangles) are divided into a hierarchy of clusters having a tree structure. The treecode replaces the O(N^2) particle-particle interactions by O(NlogN) particle-cluster interactions and TABI-PB utilizes this feature efficiently. For more details, refer to <a href="http://www.sciencedirect.com/science/article/pii/S0021999113002404">Geng (2013)</a>.

### APBS Implementation

Currently, TABI-PB on APBS is able to <a href="#electrostatics">compute electrostatic energies, generate surface potentials</a> and <a href="#pKa">calculate pKa</a>. New TABI-PB applications will be released with the implementation of new features.

To run TABI-PB on APBS, the input file requires section READ and ELEC as the following format:

{% highlight bash %}
  READ
  ...
  END

  ELEC
  ...
  END

  QUIT
{% endhighlight %}

The details of each section are:

<ul>
  <li><a href="#read">READ input file section</a></li>
  <li><a href="#elec">ELEC input file section</a></li>
</ul>

<h3 id="read">READ Keyword</h3>

The target proteins should be in the format of APBS's .pqr files. Only the first protein in the list will be calculated, the rest input of proteins will be ignored currently.

<a href="javascript:ReverseDisplay('read-keyword-mol')">mol</a>

<div id="read-keyword-mol" style="display:none;">

<p><code>mol {format} {path}</code></p>

<p>This command specifies the molecular data to be read into APBS.</p>

<p>The required arguments are:</p>

<p><code>format</code>The format of the input data. Acceptable values include:</p>

<p style="margin-left:30px;"><code>pqr</code> Specify that molecular data is in PQR format.</p>

<p><code>path</code>The location of the molecular data file.</p>
</div>
<hr />

<!---
- [mol](read-keywords/#mol)--->

#### READ examples

{% highlight bash %}
READ
   mol pqr 1a63.pqr
END
{% endhighlight %}

<h3 id="elec">ELEC</h3>

The ELEC section of the APBS input file is used for general electrostatics calculation parameters and treecode specification parameters:

{% highlight bash %}
ELEC [ name {id} ]
        bem-manual
        {keywords...}
END
{% endhighlight %}

The currently implemented keywords are:

<a href="javascript:ReverseDisplay('elec-keyword-bem-manual')">bem-manual</a>

<div id="elec-keyword-bem-manual" style="display:none;">

<p>Specifies that the TABI-PB solver should be used.</p>

The syntax is:
{% highlight bash %}
bem-manual
{% endhighlight %}

<hr />

</div>



<a href="javascript:ReverseDisplay('elec-keyword-ion')">ion</a>

<div id="elec-keyword-ion" style="display:none;">

<p>Specify the bulk concentrations of mobile ion species present in the system. This command can be repeated as necessary to specify multiple types of ions; however, only the largest ionic radius is used to determine the ion-accessibility function. The total bulk system of ions must be electroneutral which means the charge densities/concentrations of positive and negative ions must be equal.</p>

The syntax is:
{% highlight bash %}
ion charge {charge} conc {conc} radius {radius}
{% endhighlight %}

<p>where<br />
<code>charge</code> Mobile ion species charge (floating point number in e<sub>c</sub>)<br />
<code>conc</code> Mobile ion species concentration (floating point number in M)<br />
<code>radius</code> Mobile ion species radius (floating point number in Å)
</p>

<hr />

</div>



<a href="javascript:ReverseDisplay('elec-keyword-lpbe')">lpbe</a>

<div id="elec-keyword-lpbe" style="display:none;">

<p>Specifies that the linearized Poisson-Boltzmann equation should be solved.</p>

The syntax is:
{% highlight bash %}
lpbe
{% endhighlight %}

<hr />

</div>




<a href="javascript:ReverseDisplay('elec-keyword-mol')">mol</a>

<div id="elec-keyword-mol" style="display:none;">

<p>Specify the molecule for which the PBE is to be solved. IDs are based on the order in which molecules are read by <code>READ mol</code> statements, starting from 1.</p>

The syntax is:
{% highlight bash %}
mol {id}
{% endhighlight %}

<p>where <code>id</code> is the integer ID of the molecule for which the Poisson-Boltzmann equation is to be solved.</p>

<hr />

</div>






<a href="javascript:ReverseDisplay('elec-keyword-pdie')">pdie</a>

<div id="elec-keyword-pdie" style="display:none;">

<p>Specify the dielectric constant of the biomolecule. This is usually a value between 2 to 20, where lower values consider only electronic polarization and higher values consider additional polarization due to intramolecular motion.</p>

The syntax is:
{% highlight bash %}
pdie {diel}
{% endhighlight %}

where <code>die1</code> is the floating point value of the unitless biomolecular dielectric constant.

<hr />

</div>





<a href="javascript:ReverseDisplay('elec-keyword-sdens')">sdens</a>

<div id="elec-keyword-sdens" style="display:none;">

<p>Specify the number of grid points per square-angstrom to use in discontinuous surface constructions (e.g., molecular surface and solvent-accessible surfaces). There is a direct correlation between this value used for the surface sphere density, the accuracy of the surface calculations, and the APBS calculation time.</p>
<p>For TABI-PB, this parameter specifies the density parameter value that is passed to the surface meshing software, either MSMS for generating a solvent-excluded surface (SES) triangulation or NanoShaper for generation an SES or Skin surface triangulation</p>

The syntax is:
{% highlight bash %}
sdens {density}
{% endhighlight %}

<p>where <code>density</code> is the floating point surface sphere density (in grid points/Å<sup>2</sup>).</p>

<hr />

</div>




<a href="javascript:ReverseDisplay('elec-keyword-sdie')">sdie</a>

<div id="elec-keyword-sdie" style="display:none;">

<p>Specify the dielectric constant of the solvent. Bulk water at biologically-relevant temperatures is usually modeled with a dielectric constant of 78-80.</p>

The syntax is:
{% highlight bash %}
sdie {diel}
{% endhighlight %}

<p>where <code>die1</code> is a floating point number representing the solvent dielectric constant (unitless).</p>

<hr />

</div>




<a href="javascript:ReverseDisplay('elec-keyword-srad')">srad</a>

<div id="elec-keyword-srad" style="display:none;">

<p>Specify the radius of the solvent molecules; this parameter is used to define the dielectric function for probe-based dielectric definitions (see srfm). This value is usually set to 1.4 Å for water. For TABI-PB, this parameter is passed to the surface meshing software, either MSMS or NanoShaper.</p>

The syntax for this command is:
{% highlight bash %}
srad {radius}
{% endhighlight %}

<p>where <code>radius</code> is the floating point solvent radius (in Å).</p>

<hr />

</div>




<a href="javascript:ReverseDisplay('elec-keyword-temp')">temp</a>

<div id="elec-keyword-temp" style="display:none;">

<p>Specify the temperature for the Poisson-Boltzmann calculation.</p>

The syntax is:
{% highlight bash %}
temp { T }
{% endhighlight %}

<p>where <code>T</code> is a floating point number indicating the temperature in K.</p>

<div class="note info">

<h5>Note</h5>
<p>The temperature term is used for adjusting the ion distribution and scaling electrostatic potentials.  It is not used to model the temperature dependence of any dielectric terms.</p>

</div>

<hr />

</div>

<!---
- [bem-manual](elec-keyword/#bem-manual)
- [bcfl](elec-keyword/#bcfl)
- [ion](elec-keyword/#ion)
- [lpbe](elec-keyword/#lpbe)
- [mol](elec-keyword/#mol)
- [pdie](elec-keyword/#pdie)
- [sdens](elec-keyword/#sdens)
- [srad](elec-keyword/#srad)
- [srfm](elec-keyword/#srfm)
- [temp](elec-keyword/#temp)
--->


#### Treecode parameter settings

<a href="javascript:ReverseDisplay('treecode-keywords-tree_order')">tree_order</a>

<div id="treecode-keywords-tree_order" style="display:none;">

<p>Specify the order of the treecode multipole expansion.</p>

The syntax is:
{% highlight bash %}
tree_order {order}
{% endhighlight %}

<p>where <code>order</code> is an integer that indicates the Taylor expansion order. Users can adjust the order for different accuracy. In test, the results show that at order 3, treecode method can be used to evaluate solvation energy to a required level of accuracy and runtime speed.</p>

<hr />

</div>




<a href="javascript:ReverseDisplay('treecode-keywords-tree_n0')">tree_n0</a>

<div id="treecode-keywords-tree_n0" style="display:none;">

<p>Specify the maximum number of particles in a treecode leaf. This controls leaf size in the process of building the tree structure. </p>

The syntax is:
{% highlight bash %}
tree_n0 {max_number}
{% endhighlight %}

<hr />

</div>



<a href="javascript:ReverseDisplay('treecode-keywords-mac')">mac</a>

<div id="treecode-keywords-mac" style="display:none;">

<p>Multipole acceptance criterion (MAC) controls distance ratio at which the method uses direct summation or Taylor approximation (a particle-cluster interaction) to calculate the integral kernels.</p>

The syntax is:

{% highlight bash %}
mac {theta}
{% endhighlight %}

<p>where <code>theta</code> is a double from 0 to 1 controlling the distance ratio.</p>
<p>This multipole acceptance criterion (MAC) is: $\frac{r_c}{R}\leqslant \theta$</p>
<p>where $r_c$ is the cluster radius, and $R$ is the distance of the particle to the cluster center. If the above relationship is satisfied, the Taylor approximation will be used instead of direct summation.</p>

<hr />

</div>


#### Other TABI-PB specific settings

<a href="javascript:ReverseDisplay('treecode-keywords-mesh')">mesh</a>

<div id="treecode-keywords-mesh" style="display:none;">

<p>Specify the meshing software used to generate surface mesh.</p>

The syntax is:
{% highlight bash %}
mesh {flag}
{% endhighlight %}

<p>where <code>flag</code> is an integer indicating the meshing software to be used. 0 specifies MSMS, 1 specifies the SES implementation in NanoShaper, and 2 specifies the Skin surface implementation in NanoShaper. Not specifying the parameter will default the meshing software to MSMS. Note that the executables for MSMS and NanoShaper must be included in your path to use them.</p>

<hr />

</div>


<a href="javascript:ReverseDisplay('treecode-keywords-outdata')">outdata</a>

<div id="treecode-keywords-outdata" style="display:none;">

<p>Specify the file type for printing the output data.</p>

The syntax is:
{% highlight bash %}
outdata {flag}
{% endhighlight %}

<p>where <code>flag</code> is an integer indicating the output file types. 0 specifies the .dat format described below, and 1 specifies both the .dat format and a VTK polygonal data file that can be visualized in the ParaView software. The VTK file contains color mappable potentials and normal derivatives of potentials on the faces and vertices of the mesh.</p>

<hr />

</div>

<!---
- [tree_order](treecode-keywords/#tree_order)
- [tree_n0](treecode-keywords/#tree_n0)
- [mac](treecode-keywords/#mac)
--->

<h3 id="electrostatics">Electrostatics examples and output</h3>

We provide several different types of examples at <code>apbs/examples/bem/</code>. <code>1a63_msms.in</code> uses MSMS to generate surface triangles. <code>1a63_NanoShaper_SES.in</code> and <code>1a63_NanoShaper_Skin.in</code> use NanoShaper to generate surface triangles with SES and Skin schemes respectively. In addition, <code>451c_order1.in</code> and <code>451c_order5.in</code> calculate solvation energy of the biomolecules with different orders of accuracy ( orders of Taylor expansion). 
In <code>apbs/examples/bem-binding-energy/</code> and <code>apbs/examples/bem-pKa/</code>, we also provide examples to <a href = "#binding_energy">compute binding energy for DAPI bound to DNA (PDB 1d30)</a> and <a href = "#pKa">perform a lysozyme pKa calculation</a>.

#### Calculating solvation and free energy

{% highlight bash %}
read
    mol pqr 1a63.pqr       # PDB ID
end
elec name comp_solv        # Solvated complex
    bem-manual

    lpbe                   # Linearized PB
    bcfl mdh               # Full multipole boundary condition
    srfm mol               # Molecular surface

    mol 1
    ion  1 0.15 0.95       # sodium ions
    ion -1 0.15 1.81       # chloride ions
    pdie 1.0               # Solute dielectric
    sdie 80.00             # Solvent dielectric
    srad 1.4               # Solvent probe radius
    sdens 3                # NO. of Elements per A^2
    temp 300.00            # Temperature

    tree_order 1           # taylor expansion order
    tree_n0 500            # maxium particle per leaf
    mac 0.8                # multipole acceptance criterion
    mesh 0                 # meshing software flag
    outdata 1              # type of data file output flag
end

quit
{% endhighlight %}

<h4 id="binding_energy">Calculating binding energy</h4>
Users can follow the <a href="http://www.poissonboltzmann.org/examples/binding_energies/">binding energy section</a> to use TABI-PB to calculate free energy on <code>bem-binding-energy/test_proteins/1d30.pqr</code>, <code>bem-binding-energy/test_proteins/1d30_monomer1.pqr</code> and <code>bem-binding-energy/test_proteins/1d30_monomer2.pqr</code>. In the <code>bem-binding-energy</code> directory, we provide:

* <b>1d30.in</b>: 
input file of complex molecule,
* <b>1d30_monomer1.in</b>: 
input file of monomer 1,
* <b>1d30_monomer2.in</b>: 
input file of monomer 2.

After calculating and collecting these free energies by calling apbs with the respective input files <code>$ apbs foo.in</code>:
\\[ E\_{\textrm{binding energy}} = E\_{\textrm{free energy of complex}} - E\_{\textrm{free energy of monomer1}} - E\_{\textrm{free energy of monomer2}} \\]

<h4 id="pKa">Calculating pKa</h4>
Users can follow the <a href="http://www.poissonboltzmann.org/examples/Lysozyme_pKa_example/">lysozyme pKa example for PDB2PQR</a> to demonstrate the performance of TABI-PB for pKa calculation. In the <code>bem-pKa</code> directory, we provide:

* <b>2LZT-ASP66.in</b>: 
input file for ASP 66 in the protein,
* <b>ASP66.in</b>: 
input file for isolated ASP 66 in solution,
* <b>2LZT-noASP66.in</b>: 
input file for the protein with an uncharged ASP 66,
* <b>2LZT-ASH66.in</b>: 
input file for ASH 66 in the protein,
* <b>ASH66.in</b>: 
input file for isolated ASH 66 in solution,
* <b>2LZT-noASH66.in</b>: 
input file for the protein with an uncharged ASH 66.

<div class="note info">
<h5>Note</h5>
<p>The <b>PQR</b> files are in <code>bem-pKa/test_proteins/</code>. To generate these <b>PQR</b> files, please follow <a href="http://www.poissonboltzmann.org/examples/Lysozyme_pKa_example/">the lysozyme pKa example for PDB2PQR</a>.</p>
</div>

After calculating and collecting these free energies by calling apbs with the respective input files <code>$ apbs foo.in</code>:
\\[ \Delta\_{\textrm{xfer}}G\_{\textrm{ASP66}} = (G\_{\textrm{2L2T-ASP66}} - G\_{\textrm{2L2T-noASP66}} - G\_{\textrm{ASP66}}) * 4.184,\\]

\\[ \Delta\_{\textrm{xfer}}G\_{\textrm{ASH66}} = (G\_{\textrm{2L2T-ASH66}} - G\_{\textrm{2L2T-noASH66}} - G\_{\textrm{ASH66}}) * 4.184,\\]

\\[ \Delta\Delta\_{\textrm{xfer}}G = \Delta\_{\textrm{xfer}}G\_{\textrm{ASP66}} - \Delta\_{\textrm{xfer}}G\_{\textrm{ASH66}},\\]

\\[ \mathrm p K_a = \frac{\Delta\Delta\_{\textrm{xfer}}G}{2.5*2.303}. \\]


#### Electrostatics output
1) The TABI-PB code produces an output file called surface_potential.dat containing:
<ul>
  <li>number of nodes, number of triangles;</li>
  <li>node index, vertices, normal vector, surface potential [kcal/mol/$e_c$], surface potential normal derivatives [kcal/mol/$e_c$/\angstrom];</li>
  <li>connectivity data for MSMS surface triangulation.</li>
</ul>
The format is given below.

{% highlight bash %}
num_node num_triangle
node_index x y z norm_x norm_y norm_z phi norm_phi
...
node_index1 node_index2 node_index3
...
{% endhighlight %}

2) The TABI-PB code prints the free energy of solvation and Coulombic free energy in kcal/mol, along with some other information such as CPU time and the GMRES residuals at each step.

3) Additionally, TABI-PB can optionally output a VTK polygonal data file containing color mappable potentials and normal derivatives of potentials on the faces and vertices of the mesh. The VTK file can be visualized using ParaView.



<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    "HTML-CSS": {scale: 95, linebreaks: {automatic: true}},
    tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]}
 });
</script>
<script type="text/javascript"
  src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
